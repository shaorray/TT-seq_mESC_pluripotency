
if (!file.exists("data/nascent.terWin.cov_norm.RData")) {
  # process bam coverage on termination windows
  # Pol2S5p
  bam_files = list.files(path = "/mnt/E0767589767560E8/UPPMAX/PUBLISH/bam",
                         pattern = "P1.*5p.*ALL.*bam$", full.names = T)
  
  Pol2S5p.MINUTE.terWin.cov = .coverBam(bam_files, paired.end = "extend",
                                        intervals = terWindow)
  saveRDS(Pol2S5p.MINUTE.terWin.cov, "data/Pol2S5p.MINUTE.terWin.cov.RData")
  
  # TT-seq
  bam.file.iist = list("LRNA_SL" = list.files("/mnt/0E471D453D8EE463/TT_seq_data/bam_sl_2i_mm9",
                                              pattern = "LRNA.*(SL_).*bam$", full.names = T),
                       "LRNA_2i" = list.files("/mnt/0E471D453D8EE463/TT_seq_data/bam_sl_2i_mm9",
                                              pattern = "LRNA.*(_2i_2d).*bam$", full.names = T),
                       "LRNA_mTORi" = list.files("/mnt/0E471D453D8EE463/TT_seq_data/bam_sl_2i_mm9",
                                                 pattern = "LRNA.*(mTORi_2d).*bam$", full.names = T))
  
  TTseq.terWin.cov = lapply(bam.file.iist, .coverBam, 
                            intervals = terWindow, paired.end = "extend")
  
  L_sf = readRDS("../data/LRNA.sizefactor.RData")
  size.factor.list = list("LRNA_SL" = L_sf[grep("SL_", names(L_sf))],
                          "LRNA_2i" = L_sf[grep("^2i_2", names(L_sf))],
                          "LRNA_mTORi" = L_sf[grep("mTORi_2", names(L_sf))])
  
  # normalize with size factors, and combine replicates
  TTseq.terWin.cov_norm <- vector(mode = "list", length = length(TTseq.terWin.cov))
  names(TTseq.terWin.cov_norm) <- names(TTseq.terWin.cov)
  for (sample in names(TTseq.terWin.cov)) { 
    TTseq.terWin.cov_norm[[sample]] <- 
      sapply(seq_along(TTseq.terWin.cov[[sample]][[1]]), 
             function(i) 
               rowMeans(sapply(seq_along(TTseq.terWin.cov[[sample]]),
                               function(x) TTseq.terWin.cov[[sample]][[x]][i] / size.factor.list[[sample]][x]))
      )
  }
  saveRDS(TTseq.terWin.cov_norm, "data/TTseq.terWin.cov_norm.RData")
  
  # other nascent RNA-seq
  bam.file.iist = list("Jan_TTseq" = list.files("/mnt/0E471D453D8EE463/nascent_RNA_mm9/2018_Jan_TTseq_TX1072_1/bam/",
                                                     pattern = "out.bam$", full.names = T),
                       "Jesse_PROseq" = c(list.files("/mnt/0E471D453D8EE463/nascent_RNA_mm9/2016_Jesse_PROSeq_ControlClone2_Rep1/bam",
                                                   pattern = "out.bam$", full.names = T),
                                          list.files("/mnt/0E471D453D8EE463/nascent_RNA_mm9/2016_Jesse_PROSeq_ControlClone2_Rep2/bam",
                                                     pattern = "out.bam$", full.names = T)),
                       "Marta_PROseq" = c(list.files("/mnt/0E471D453D8EE463/nascent_RNA_mm9/2018_Marta_ESC_1_PRO-Seq_ctrl/bam",
                                                     pattern = "out.bam$", full.names = T),
                                          list.files("/mnt/0E471D453D8EE463/nascent_RNA_mm9/2018_Marta_ESC_2_PRO-Seq_ctrl/bam",
                                                     pattern = "out.bam$", full.names = T))
                       )
  
  nascent.terWin.cov = lapply(bam.file.iist, .coverBam, 
                              intervals = terWindow, is.resize = F)
  nascent.terWin.cov_norm <- vector(mode = "list", length = length(nascent.terWin.cov))
  names(nascent.terWin.cov_norm) <- names(nascent.terWin.cov)
  for (sample in names(nascent.terWin.cov)) {
    nascent.terWin.cov_norm[[sample]] <- 
      sapply(seq_along(nascent.terWin.cov[[sample]][[1]]), 
             function(i) 
               rowMeans(sapply(seq_along(nascent.terWin.cov[[sample]]), function(x) nascent.terWin.cov[[sample]][[x]][i]))
      )
  }
  saveRDS(nascent.terWin.cov_norm, "data/nascent.terWin.cov_norm.RData")
  
  # other Pol II ChIP
  bam.file.iist = list("Ferrai_Pol_II_S5p" = list.files("/mnt/0E471D453D8EE463/GEO_pol2/2017_Ferrai_ChIP_RNAPIIS5p_ESC/bam",
                                                        pattern = "Ferrai.*bam$", full.names = T),
                       "Ferrai_Pol_II_S7p" = list.files("/mnt/0E471D453D8EE463/GEO_pol2/2017_Ferrai_ChIP_RNAPIIS7p_ESC/bam",
                                                        pattern = "Ferrai.*bam$", full.names = T),
                       "Flynn_Pol_II_DMSO" = list.files("/mnt/0E471D453D8EE463/GEO_pol2/2016_Flynn_ChIPseq_mES_Pol_II_DMSO_JQ1/",
                                                        pattern = "DMSO.*bam$", full.names = T),
                       "Flynn_Pol_II_JQ1" = list.files("/mnt/0E471D453D8EE463/GEO_pol2/2016_Flynn_ChIPseq_mES_Pol_II_DMSO_JQ1/",
                                                       pattern = "JQ1.*bam$", full.names = T))
  pol2.terWin.cov = lapply(bam.file.iist, .coverBam, 
                           intervals = terWindow, is.resize = F)
  pol2.terWin.cov_norm <- vector(mode = "list", length = length(pol2.terWin.cov))
  names(pol2.terWin.cov_norm) <- names(pol2.terWin.cov)
  for (sample in names(pol2.terWin.cov)) {
    pol2.terWin.cov_norm[[sample]] <- 
      sapply(seq_along(pol2.terWin.cov[[sample]][[1]]), 
             function(i) 
               rowMeans(sapply(seq_along(pol2.terWin.cov[[sample]]), function(x) pol2.terWin.cov[[sample]][[x]][i]))
      )
  }
  saveRDS(pol2.terWin.cov_norm, "data/pol2.terWin.cov_norm.RData")
}

# add SL2i TT-seq coverage, Sep 10 2021
if (F) {
  TTseq.SL2i.terWin.cov <- .coverBam(bam_files = list.files("/mnt/0E471D453D8EE463/TT_seq_data/bam_sl_2i_mm9",
                                                           pattern = "LRNA.*(SL2i_).*bam$", full.names = T), 
                                    intervals = terWindow,
                                    paired.end = "extend")
  
  L_RNA_SL2i_sf <- readRDS("../data/LRNA.sizefactor.RC.RData")[c("SL2i_2d_rep1",  "SL2i_2d_rep2")]
  
  TTseq.SL2i.terWin.cov2 <- sapply(seq_along(TTseq.SL2i.terWin.cov[[1]]), 
                                  function(i) 
                                    rowMeans(sapply(seq_along(TTseq.SL2i.terWin.cov),
                                                    function(x) TTseq.SL2i.terWin.cov[[x]][i] / L_RNA_SL2i_sf[x]))
  )
}
